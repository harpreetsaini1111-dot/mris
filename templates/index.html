<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Malwa Diagnostic Imaging – RIS</title>
<style>
body{
    font-family: Segoe UI, Arial, sans-serif;
    background:#f3f6fb;
    margin:0;
    padding:20px;
}
.container{
    max-width:1200px;
    margin:auto;
    background:#fff;
    padding:20px;
    border-radius:10px;
    box-shadow:0 10px 30px rgba(0,0,0,.08);
}
h1{margin:0 0 15px 0;color:#1f2937}
.grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
input,select{padding:8px;border:1px solid #ccc;border-radius:6px;font-size:14px}
.toolbar{margin:10px 0}
.toolbar select{padding:6px;font-size:13px}
.editor{border:1px solid #ccc;border-radius:8px;min-height:500px;padding:18px;font-size:14px;line-height:1.6;outline:none}
.actions{margin-top:12px}
.actions button{padding:8px 12px;border:none;border-radius:6px;font-size:13px;cursor:pointer;margin-right:6px;color:#fff}
.save{background:#16a34a}
.print{background:#2563eb}
.clear{background:#dc2626}
.footer{margin-top:15px;font-size:12px;color:#6b7280}
</style>
</head>
<body>
<div class="container">
<h1>Malwa Diagnostic Imaging – RIS</h1>

<div class="grid">
    <input id="patient" placeholder="Patient Name">
    <input id="age" placeholder="Age / Sex">
    <input id="uhid" placeholder="UHID">
    <input id="ref" placeholder="Referring Doctor">
</div>

<div class="grid" style="margin-top:10px">
    <select id="modality" onchange="loadTemplates()">
        <option value="">Modality</option>
        <option value="CT">CT</option>
        <option value="MRI">MRI</option>
        <option value="USG">USG</option>
        <option value="XRAY">X-Ray</option>
    </select>
    <select id="template" onchange="loadTemplateContent()">
        <option value="">Select Template</option>
    </select>
    <input id="date" placeholder="Date">
    <input id="study" placeholder="Study ID">
</div>

<div class="toolbar">
<select onchange="cmd(this.value);this.selectedIndex=0">
    <option value="">Formatting</option>
    <option value="bold">Bold</option>
    <option value="italic">Italic</option>
    <option value="underline">Underline</option>
    <option value="insertUnorderedList">Bullet List</option>
    <option value="insertOrderedList">Numbered List</option>
</select>
</div>

<div id="editor" class="editor" contenteditable="true">
<b>Findings:</b><br><br>
<b>Impression:</b>
</div>

<div class="actions">
    <button class="save" onclick="saveReport()">Save</button>
    <button class="print" onclick="window.print()">Print</button>
    <button class="clear" onclick="document.getElementById('editor').innerHTML=''">Clear</button>
    <button style="background:#7c3aed" onclick="downloadWord()">Word</button>
    <button style="background:#0ea5e9" onclick="openFetch()">Fetch</button>
    <button style="background:#f59e0b" onclick="openUpload()">Upload</button>
</div>

<!-- FETCH MODAL -->
<div id="fetchModal" style="display:none;margin-top:15px">
<h3>Fetch Saved Reports</h3>
<div class="grid">
<input id="f_name" placeholder="Patient Name">
<select id="f_modality"><option value="">Modality</option><option>CT</option><option>MRI</option><option>USG</option><option>XRAY</option></select>
<input id="f_date" placeholder="Date">
<button onclick="searchReports()">Search</button>
</div>
<ul id="fetchResults"></ul>
</div>

<!-- UPLOAD MODAL -->
<div id="uploadModal" style="display:none;margin-top:15px">
<h3>Upload Report (MS Word)</h3>
<div class="grid">
<input id="u_name" placeholder="Patient Name">
<select id="u_modality"><option>CT</option><option>MRI</option><option>USG</option><option>XRAY</option></select>
<input id="u_date" placeholder="Date">
<input type="file" id="u_file" accept=".docx">
<button onclick="uploadReport()">Upload</button>
</div>
</div>

<div class="footer">Imaging opinion only. Clinical correlation advised.</div>
</div>

<script>
function cmd(c){document.execCommand(c,false,null)}

function loadTemplates(){
    const modality = document.getElementById('modality').value;
    fetch(`/api/templates?modality=${modality}`)
    .then(r=>r.json())
    .then(data=>{
        const sel = document.getElementById('template');
        sel.innerHTML='<option value="">Select Template</option>';
        data.forEach(t=>{
            sel.innerHTML += `<option value="${t.id}">${t.name}</option>`;
        });
    });
}

function loadTemplateContent(){
    const tid = document.getElementById('template').value;
    fetch(`/api/template/${tid}`)
    .then(r=>r.json())
    .then(d=>{ editor.innerHTML = d.content; });
}

function downloadWord(){
    fetch('/api/export-word',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({
        patient:patient.value,age:age.value,uhid:uhid.value,ref:ref.value,modality:modality.value,date:date.value,report:editor.innerHTML
    })}).then(r=>r.blob()).then(b=>{const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download=`${uhid.value}_${modality.value}_${date.value}.docx`;a.click()})
}

function openFetch(){fetchModal.style.display='block';uploadModal.style.display='none'}
function openUpload(){uploadModal.style.display='block';fetchModal.style.display='none'}

function searchReports(){
    fetch(`/api/search?name=${f_name.value}&modality=${f_modality.value}&date=${f_date.value}`)
    .then(r=>r.json()).then(d=>{fetchResults.innerHTML='';d.forEach(x=>{const li=document.createElement('li');li.textContent=`${x.patient} | ${x.modality} | ${x.date}`;li.onclick=()=>editor.innerHTML=x.report;fetchResults.appendChild(li)})})
}

function uploadReport(){
    const fd=new FormData();
    fd.append('file',u_file.files[0]);
    fd.append('patient',u_name.value);
    fd.append('modality',u_modality.value);
    fd.append('date',u_date.value);
    fetch('/api/upload-report',{method:'POST',body:fd}).then(()=>alert('Uploaded'))
}

function saveReport(){
    const payload = {
        patient: patient.value,
        age: age.value,
        uhid: uhid.value,
        ref: ref.value,
        modality: modality.value,
        date: date.value,
        report: editor.innerHTML
    };
    fetch('/api/save-report',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)})
    .then(r=>r.json()).then(()=>alert('Report saved'));
}
</script>
</body>
</html>
